name: ProcessHistory
description: Flattens Forward-Forward training history into epoch-loss rows and limits output to top N entries.

inputs:
  - name: training_history_json
    type: String
  - name: mapping_json
    type: String

outputs:
  - name: processed_history_json
    type: String

implementation:
  container:
    image: python:3.9-slim
    command:
      - python3
      - -u
      - -c
      - |
        import json
        import argparse
        import os

        def flatten_forward_forward(history, max_rows=5):
            rows = []
            epoch = 0

            ff_results = history.get("ff_results", {})
            block_results = ff_results.get("block_results", [])

            for block in block_results:
                losses = block.get("epoch_losses", [])
                for loss in losses:
                    rows.append({
                        "epoch": epoch,
                        "loss": float(loss)
                    })
                    epoch += 1

            # Take top N rows only (first N epochs)
            return rows[:max_rows]

        parser = argparse.ArgumentParser()
        parser.add_argument("--training_history_json", required=True)
        parser.add_argument("--mapping_json", required=True)
        parser.add_argument("--processed_history_json", required=True)
        args = parser.parse_args()

        history = json.loads(args.training_history_json)

        if "ff_results" not in history:
            raise ValueError("Unsupported training history format")

        processed_rows = flatten_forward_forward(history, max_rows=5)

        output = {
            "data": processed_rows
        }

        os.makedirs(os.path.dirname(args.processed_history_json), exist_ok=True)
        with open(args.processed_history_json, "w") as f:
            json.dump(output, f, indent=2)

        print("Processed training history:")
        print(json.dumps(output, indent=2))

    args:
      - --training_history_json
      - {inputValue: training_history_json}
      - --mapping_json
      - {inputValue: mapping_json}
      - --processed_history_json
      - {outputPath: processed_history_json}
